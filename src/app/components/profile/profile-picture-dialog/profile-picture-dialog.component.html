<div class="profile-picture-dialog">
  @if (error()) {
    <p-message severity="error" [text]="error()!" styleClass="w-full mb-3" />
  }
  @if (!previewUrl()) {
    <div
      class="drop-zone"
      [class.dragging]="isDraggingFile()"
      (dragover)="onDragOver($event)"
      (dragleave)="onDragLeave($event)"
      (drop)="onDrop($event)"
      (click)="fileInput.click()"
    >
      <input
        #fileInput
        type="file"
        accept="image/jpeg,image/png,image/gif,image/webp"
        (change)="onFileSelected($event)"
        hidden
      />
      <div class="drop-zone-content">
        <i class="ti ti-photo-up drop-icon"></i>
        <p class="drop-text">Drag & drop an image here</p>
        <p class="drop-subtext">or click to browse</p>
        <p class="drop-hint">JPEG, PNG, GIF, or WebP (max 5MB)</p>
      </div>
    </div>
  } @else {
    <div class="crop-container">
      <p class="crop-instructions">Drag to reposition, use slider to zoom</p>
      <div
        class="crop-area"
        (mousedown)="onImageDragStart($event)"
        (mousemove)="onImageDrag($event)"
        (mouseup)="onImageDragEnd()"
        (mouseleave)="onImageDragEnd()"
        (touchstart)="onImageDragStart($event)"
        (touchmove)="onImageDrag($event)"
        (touchend)="onImageDragEnd()"
      >
        <div class="crop-mask">
          <img
            #cropImage
            [src]="previewUrl()"
            alt="Crop preview"
            class="crop-image"
            [ngStyle]="imageStyle()"
            [style.transform]="imageTransform()"
            [class.dragging]="isDraggingImage()"
            (load)="onImageLoad($event)"
            draggable="false"
          />
        </div>
        <div class="crop-overlay"></div>
      </div>
      <div class="zoom-controls">
        <p-button
          icon="ti ti-zoom-out"
          [rounded]="true"
          [text]="true"
          (click)="zoomOut()"
          [disabled]="zoom() <= 0.5"
        />
        <p-slider
          [ngModel]="zoom()"
          (ngModelChange)="zoom.set($event)"
          [min]="0.5"
          [max]="3"
          [step]="0.05"
          class="zoom-slider"
        />
        <p-button
          icon="ti ti-zoom-in"
          [rounded]="true"
          [text]="true"
          (click)="zoomIn()"
          [disabled]="zoom() >= 3"
        />
      </div>
      <p-button
        label="Choose different image"
        icon="ti ti-refresh"
        severity="secondary"
        [outlined]="true"
        size="small"
        (click)="clearSelection()"
      />
    </div>
  }
  <div class="dialog-footer">
    <p-button
      label="Cancel"
      severity="secondary"
      [outlined]="true"
      (click)="cancel()"
      [disabled]="isUploading()"
    />
    <p-button
      label="Save"
      icon="ti ti-check"
      (click)="upload()"
      [disabled]="!selectedFile() || !imageLoaded() || isUploading()"
      [loading]="isUploading()"
    />
  </div>
</div>
