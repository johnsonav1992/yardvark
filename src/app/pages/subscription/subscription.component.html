<page-container pageTitle="Subscription">
  @if (isLoadingSubscription()) {
    <p-card class="mb-4">
      <div class="skeleton-banner">
        <p-skeleton width="6rem" height="2rem" borderRadius="16px" />
        <p-skeleton width="15rem" height="1.25rem" />
        <p-skeleton width="8rem" height="2.5rem" borderRadius="6px" styleClass="ml-auto" />
      </div>
    </p-card>
  } @else if (isPro()) {
    <p-message [closable]="false" class="mb-4 pro-banner">
      <div class="plan-status-content">
        <div class="plan-info">
          <p-tag [value]="tierDisplayName" severity="secondary">
            <ng-template #icon>
              <i class="ti ti-crown"></i>
            </ng-template>
          </p-tag>
          @if (subscription()?.tier === "lifetime") {
            <span
              >You have lifetime pro access! Thank you for being an early
              adopter.</span
            >
          } @else {
            <span>
              @if (subscription()?.tier === "monthly") {
                Next charge on
              } @else {
                Your plan is active until
              }
              <strong>{{ subscriptionEndDate }}</strong>
            </span>
            @if (willCancelAtPeriodEnd) {
              <small class="cancel-warning">
                <i class="ti ti-alert-circle"></i>
                Cancels at end of billing period
              </small>
            }
          }
        </div>
        @if (subscription()?.tier !== "lifetime") {
          <p-button
            label="Manage Subscription"
            icon="ti ti-settings"
            (onClick)="manageSubscription()"
            [loading]="isManaging()"
            severity="secondary"
            outlined
            size="small"
          />
        }
      </div>
    </p-message>
  } @else {
    <p-message severity="info" [closable]="false" class="mb-4">
      <div class="plan-status-content">
        <div class="plan-info">
          <p-tag value="Free Plan" severity="secondary" />
          <span>Limited to 6 entries per month with no additional pro features</span>
        </div>
      </div>
    </p-message>
  }
  <h3 class="section-title">Choose Your Plan</h3>
  <div class="pricing-grid">
    @if (isLoadingSubscription() || isPricingLoading()) {
      @for (i of [1, 2]; track i) {
        <p-card class="pricing-card">
          <ng-template #header>
            <div class="card-header-content">
              <p-skeleton width="6rem" height="2rem" borderRadius="16px" />
              <p-skeleton width="8rem" height="2rem" />
              <p-skeleton width="10rem" height="3rem" />
            </div>
          </ng-template>
          <p-divider />
          <div class="skeleton-features">
            @for (j of [1, 2, 3, 4, 5]; track j) {
              <div class="skeleton-feature">
                <p-skeleton shape="circle" size="1.25rem" />
                <p-skeleton width="100%" height="1rem" />
              </div>
            }
          </div>
          <ng-template #footer>
            <p-skeleton width="100%" height="2.5rem" borderRadius="6px" />
          </ng-template>
        </p-card>
      }
    } @else {
      @for (plan of plans(); track plan.tier) {
      <p-card
        [class]="
          'pricing-card' +
          (plan.popular ? ' popular' : '') +
          (isPro() && subscription()?.tier === plan.tier ? ' current' : '')
        "
      >
        <ng-template #header>
          <div class="card-header-content">
            @if (plan.popular) {
              <p-tag value="Most Popular" severity="secondary">
                <ng-template #icon>
                  <i class="ti ti-star"></i>
                </ng-template>
              </p-tag>
            }
            @if (isPro() && subscription()?.tier === plan.tier) {
              <p-tag value="Current Plan" severity="secondary">
                <ng-template #icon>
                  <i class="ti ti-check"></i>
                </ng-template>
              </p-tag>
            }
            <h3 class="plan-name">{{ plan.name }}</h3>
            <div class="plan-pricing">
              <span class="price">${{ plan.price }}</span>
              <span class="period">/ {{ plan.period }}</span>
            </div>
            @if (plan.tier === "yearly") {
              <p-tag
                value="Save $24/year"
                severity="secondary"
                [rounded]="true"
              />
            }
          </div>
        </ng-template>

        <p-divider />

        <ul class="features-list">
          @for (feature of plan.features; track feature) {
            <li>
              <i class="ti ti-circle-check"></i>
              <span>{{ feature }}</span>
            </li>
          }
        </ul>

        <ng-template #footer>
          <p-button
            [label]="
              isPro() && subscription()?.tier === plan.tier
                ? 'Current Plan'
                : isPro() && subscription()?.tier === 'lifetime'
                  ? 'Lifetime Active'
                  : 'Get Started'
            "
            [disabled]="
              isPro() &&
              (subscription()?.tier === plan.tier ||
                subscription()?.tier === 'lifetime')
            "
            [loading]="loadingTier() === plan.tier"
            (onClick)="subscribe(plan.tier)"
            class="w-full"
          />
        </ng-template>
      </p-card>
      }
    }
  </div>
  @if (!isPro()) {
    <p-divider />
    <h3 class="section-title">Why Upgrade to Pro?</h3>
    <div class="benefits-grid">
      <p-card class="benefit-card">
        <div class="benefit-content">
          <i class="ti ti-infinity benefit-icon"></i>
          <h4>Unlimited Entries</h4>
          <p>
            Track every lawn care activity without worrying about monthly limits
          </p>
        </div>
      </p-card>

      <p-card class="benefit-card">
        <div class="benefit-content">
          <i class="ti ti-sparkles benefit-icon"></i>
          <h4>AI-Powered Insights</h4>
          <p>
            Get personalized recommendations and lawn health analysis powered by
            AI
          </p>
        </div>
      </p-card>

      <p-card class="benefit-card">
        <div class="benefit-content">
          <i class="ti ti-chart-line benefit-icon"></i>
          <h4>Advanced Analytics</h4>
          <p>
            Access detailed analytics and insights to optimize your lawn care
            routine
          </p>
        </div>
      </p-card>

      <p-card class="benefit-card">
        <div class="benefit-content">
          <i class="ti ti-headset benefit-icon"></i>
          <h4>Priority Support</h4>
          <p>Get help faster with priority email support from our team</p>
        </div>
      </p-card>
    </div>
  }
</page-container>
