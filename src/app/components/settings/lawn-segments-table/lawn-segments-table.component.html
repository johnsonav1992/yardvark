<p-card>
  <p-table
    [value]="lawnSegments() || []"
    [loadingIcon]="'ti ti-loader-2 icon-spin'"
    [dt]="lawnSegsTableDt"
    editMode="row"
    dataKey="id"
    [loading]="lawnSegmentsAreLoading()"
    #lawnSegmentTable
  >
    <ng-template #header>
      <tr>
        @if (lawnSegments()?.length) {
          <th>Color</th>
          <th>Name</th>
          <th>Size (ft²)</th>
          <th></th>
        }
      </tr>
    </ng-template>
    <ng-template #body let-segment let-editing="editing">
      <tr [pEditableRow]="segment">
        <td>
          <div class="color-cell">
            <div
              class="color-indicator"
              [style.background-color]="segment.color || '#3388ff'"
              [class.not-mapped]="!segment.coordinates"
            ></div>
          </div>
        </td>
        <td>
          <p-cellEditor>
            <ng-template #input>
              <input
                pInputText
                [style]="{ width: '75%' }"
                [(ngModel)]="segment.name"
                (ngModelChange)="onSegmentNameChange(segment)"
              />
            </ng-template>
            <ng-template #output>
              {{ segment.name }}
            </ng-template>
          </p-cellEditor>
        </td>
        <td>
          <span class="size-display">
            @if (segment.size && +segment.size > 0) {
              {{ (+segment.size).toFixed(2) }}
            } @else {
              <span class="not-mapped-text">Not mapped</span>
            }
          </span>
        </td>
        <td>
          <div class="buttons-container">
            @let isRowBeingEdited = editing;
            @let isInEditingMode =
              !!currentlyEditingLawnSegmentIds()?.includes(segment.id);
            @let isNewSegment = segment.id < 1;
            @if (isRowBeingEdited && isInEditingMode) {
              <p-button
                [icon]="'ti ti-check'"
                rounded
                outlined
                severity="success"
                pSaveEditableRow
                [disabled]="!segment.name"
                (onClick)="onRowSave(segment)"
                [pTooltip]="!segment.name ? 'Enter a name to save' : ''"
              />
              <p-button
                [icon]="'ti ti-x'"
                rounded
                outlined
                severity="info"
                pCancelEditableRow
                (onClick)="cancelRowEdit(segment)"
              />
            } @else {
              <p-button
                [icon]="'ti ti-pencil'"
                (onClick)="editLawnSegment(segment)"
                rounded
                outlined
                severity="info"
                pInitEditableRow
                [disabled]="isInEditingMode && !isRowBeingEdited"
              />
            }
            @if (!isNewSegment) {
              <p-button
                icon="ti ti-trash"
                (onClick)="deleteSegment(segment.id)"
                rounded
                outlined
                severity="danger"
              />
            }
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template #emptymessage>
      <td colspan="4">
        <div class="empty-or-loading">
          <i class="ti ti-table" [class.icon]="true"></i>
          <h3 [style]="{ margin: 0 }">No lawn segments found</h3>
          <p-button
            icon="ti ti-plus"
            label="Add Lawn Segment"
            (onClick)="addLawnSegmentRow()"
          />
        </div>
      </td>
    </ng-template>
    <ng-template #loadingbody>
      <td colspan="4">
        <div class="empty-or-loading">
          <loading-spinner size="s" />
          <h3 [style]="{ margin: 0 }">Loading lawn segments...</h3>
        </div>
      </td>
    </ng-template>
    @if (lawnSegments()?.length) {
      <ng-template #footer>
        <div class="table-footer">
          <p-button
            [icon]="'ti ti-plus'"
            rounded
            pTooltip="Add lawn segment"
            (onClick)="addLawnSegmentRow()"
          />
          <div class="total-size">
            <span class="total-label">Total:</span>
            <span class="total-value"
              >{{ totalLawnSize() | number: "1.0-0" }} ft²</span
            >
          </div>
        </div>
      </ng-template>
    }
  </p-table>
</p-card>
