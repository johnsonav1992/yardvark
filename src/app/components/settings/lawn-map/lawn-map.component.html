<p-card>
  <div class="map-header">
    <h4>Lawn Map</h4>
    @if (!currentSettings()?.location) {
      <small class="location-warning">
        <i class="ti ti-alert-circle"></i>
        Set your location in the settings above to see your property on the map
      </small>
    }
    @if (targetSegmentForDrawing()) {
      <div class="color-picker-wrapper">
        <label>Segment Color:</label>
        <input
          type="color"
          [ngModel]="selectedColor()"
          (ngModelChange)="onColorChange($event)"
          class="color-input"
        />
      </div>
    }
  </div>

  @if (targetSegmentForDrawing(); as targetSegment) {
    @let isNewSegment = targetSegment.id < 1;
    <div class="drawing-mode-banner">
      <div class="banner-content">
        <i class="ti ti-map-pin"></i>
        <div class="banner-text">
          @if (isNewSegment) {
            <strong>Creating new segment</strong>
            <span>
              @if (targetSegment.coordinates) {
                Adjust the shape and color, then save in the table
              } @else {
                Draw the shape for your new segment
              }
            </span>
          } @else {
            <strong>{{ targetSegment.coordinates ? 'Editing' : 'Drawing' }} mode active</strong>
            <span>
              @if (targetSegment.coordinates) {
                Edit the shape for "{{ targetSegment.name }}"
              } @else {
                Draw the shape for "{{ targetSegment.name }}"
              }
            </span>
          }
        </div>
      </div>
      @if (!targetSegment.coordinates) {
        <p-button
          [icon]="'ti ti-x'"
          [text]="true"
          severity="secondary"
          size="small"
          (onClick)="cancelEditing()"
        />
      }
    </div>
  }

  <div id="lawn-map" [style]="{ height: isMobile() ? '400px' : '600px' }"></div>
  <div class="map-instructions">
    <small>
      <i class="ti ti-info-circle"></i>
      Click <strong>edit</strong> in the table above to draw or modify a segment. For new shapes, use the polygon tool and click the first point to finish.
      Use the color picker to change segment colors. Save your changes via the <strong>checkmark</strong> in the table.
    </small>
  </div>
</p-card>

<p-dialog
  [(visible)]="showSegmentDialog"
  [modal]="true"
  [closable]="true"
  [style]="{ width: isMobile() ? '90vw' : '450px' }"
  [contentStyle]="{ overflow: 'visible' }"
  header="New Lawn Segment"
>
  @if (currentSegment(); as segment) {
    <div class="segment-form">
      <div class="form-field">
        <label>Segment Name</label>
        <input
          pInputText
          [(ngModel)]="segment.name"
          placeholder="Enter segment name"
          [style]="{ width: '100%' }"
        />
      </div>
      <div class="form-field">
        <label>Square Footage</label>
        <input
          pInputText
          [ngModel]="segment.size ? (+segment.size).toFixed(2) : ''"
          [disabled]="true"
          [style]="{ width: '100%' }"
        />
      </div>
      <div class="form-field">
        <label>Color</label>
        <input
          type="color"
          [ngModel]="segment.color"
          (ngModelChange)="updateNewSegmentColor($event)"
          class="color-input"
        />
      </div>
    </div>
    <div class="dialog-footer">
      <p-button
        label="Cancel"
        severity="secondary"
        (onClick)="cancelNewSegment()"
      />
      <p-button
        label="Save"
        severity="success"
        (onClick)="saveNewSegment()"
        [disabled]="!segment.name"
      />
    </div>
  }
</p-dialog>

